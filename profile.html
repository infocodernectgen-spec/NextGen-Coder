<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My Profile ‚Ä¢ Gyan Bakery</title>
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="assets/invoice.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-wrap">
      <a class="logo" href="index.html"><span>Gyan Bakery</span></a>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="cart.html">Cart <span id="cartBadge" class="badge" style="display:none;"></span></a>
        <a href="#" onclick="logout()">Logout</a>
      </nav>
    </div>
  </header>

  <section class="container mt-4">
    <div class="grid-2" style="grid-template-columns: 1fr 3fr;">
      <aside>
        <div style="background:white; padding:1.5rem; border-radius:12px; text-align:center; box-shadow: var(--shadow);">
          <div class="profile-pic-container" onclick="document.getElementById('profileImageInput').click()">
            <img id="profileImageDisplay" src="https://ui-avatars.com/api/?name=User&background=fce7f3&color=d946ef" alt="Profile">
            <input type="file" id="profileImageInput" hidden accept="image/*" onchange="handleImageUpload(event)">
          </div>
          <h2 id="userNameDisplay" style="margin: 0.5rem 0 0.25rem; font-size: 1.5rem;">User Name</h2>
          <p id="userEmailDisplay" class="text-muted" style="margin-bottom: 1.5rem;">user@example.com</p>
          
          <div style="background:#f8fafc; padding:1.5rem; border-radius:12px; margin-bottom: 1rem;">
            <p class="text-sm text-muted" style="margin-bottom: 0.5rem;">Wallet Balance</p>
            <h1 id="walletBalance" style="margin-bottom: 1rem; font-size: 2.25rem;">‚Çπ0</h1>
            <button class="btn primary sm w-full" style="border-radius: 8px; font-size: 1rem;" onclick="addMoney()">Add Money</button>
          </div>
          
          <button class="btn outline sm w-full" style="color: var(--primary); font-weight: 600;" onclick="toggleEditProfile()">Edit Profile</button>
        </div>

        <div id="editProfileSection" style="display:none; background:white; padding:1.5rem; border-radius:12px; margin-top:1rem; box-shadow: var(--shadow);">
          <h3>Update Profile</h3>
          <form id="editProfileForm" onsubmit="updateProfile(event)" class="mt-2 text-left">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="editName" required>
            </div>
            <div class="form-group">
              <label>Phone Number</label>
              <input type="tel" id="editPhone" required>
            </div>
            <div class="form-group">
              <label>Delivery Address</label>
              <textarea id="editAddress" required rows="2"></textarea>
            </div>
            <button type="submit" class="btn primary sm w-full" style="border-radius: 8px;">Save Changes</button>
          </form>
        </div>
      </aside>
      
      <main>
        <h2>My Orders</h2>
        <div id="ordersList" class="mt-4">
          <!-- JS -->
        </div>
      </main>
    </div>
  </section>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="modal" style="display:none; align-items:flex-start; padding-top:2rem;">
    <div style="background:white; padding:1.5rem; border-radius:12px; width:100%; max-width:800px; position:relative;">
      <div class="flex justify-between items-center mb-4 no-print">
        <h3>Order Invoice</h3>
        <div class="flex gap-2">
          <button class="btn primary sm" onclick="window.print()">Print</button>
          <button class="btn outline sm" onclick="closeInvoice()">Close</button>
        </div>
      </div>
      <div id="invoiceContent" class="invoice-box">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>

  <script>
    const renderProfile = () => {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const updatedUser = users.find(u => u.email === user.email) || user;
      
      document.getElementById("userNameDisplay").textContent = updatedUser.name;
      document.getElementById("userEmailDisplay").textContent = updatedUser.email;
      document.getElementById("walletBalance").textContent = `‚Çπ${updatedUser.wallet || 0}`;
      document.getElementById("editName").value = updatedUser.name;
      document.getElementById("editPhone").value = updatedUser.phone || "";
      document.getElementById("editAddress").value = updatedUser.address || "";
      
      if (updatedUser.image) {
        document.getElementById("profileImageDisplay").src = updatedUser.image;
      } else {
        document.getElementById("profileImageDisplay").src = `https://ui-avatars.com/api/?name=${encodeURIComponent(updatedUser.name)}&background=fce7f3&color=d946ef`;
      }
    };

    renderProfile();

    window.handleImageUpload = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const imgData = event.target.result;
        const user = JSON.parse(localStorage.getItem("user"));
        const users = JSON.parse(localStorage.getItem("users") || "[]");
        const idx = users.findIndex(u => u.email === user.email);

        if (idx >= 0) {
          users[idx].image = imgData;
          localStorage.setItem("users", JSON.stringify(users));
          renderProfile();
        }
      };
      reader.readAsDataURL(file);
    };

    window.addMoney = () => {
      const amt = prompt("Enter amount to add (mock payment):");
      if (!amt || isNaN(amt)) return;
      
      const user = JSON.parse(localStorage.getItem("user"));
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const idx = users.findIndex(u => u.email === user.email);
      
      if (idx >= 0) {
        users[idx].wallet = (users[idx].wallet || 0) + parseInt(amt);
        localStorage.setItem("users", JSON.stringify(users));
        renderProfile();
      } else {
        // First user?
        users.push({...user, wallet: parseInt(amt)});
        localStorage.setItem("users", JSON.stringify(users));
        renderProfile();
      }
    };

    window.toggleEditProfile = () => {
      const section = document.getElementById("editProfileSection");
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    };

    window.updateProfile = (e) => {
      e.preventDefault();
      const newName = document.getElementById("editName").value;
      const newPhone = document.getElementById("editPhone").value;
      const newAddress = document.getElementById("editAddress").value;
      
      const user = JSON.parse(localStorage.getItem("user"));
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const idx = users.findIndex(u => u.email === user.email);
      
      if (idx >= 0) {
        users[idx].name = newName;
        users[idx].phone = newPhone;
        users[idx].address = newAddress;
        localStorage.setItem("users", JSON.stringify(users));
        localStorage.setItem("user", JSON.stringify({ name: newName, email: user.email }));
        
        renderProfile();
        toggleEditProfile();
        alert("Profile updated successfully!");
      }
    };

    window.logout = () => {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    };

    // Render Orders
    const orders = JSON.parse(localStorage.getItem("orders") || "[]");
    const container = document.getElementById("ordersList");
    
    if (orders.length === 0) {
      container.innerHTML = "<p>No orders yet.</p>";
    } else {
      container.innerHTML = orders.map(o => `
        <div style="background:white; padding:1.5rem; border-radius:12px; margin-bottom:1rem; border:1px solid #eee;">
          <div class="flex justify-between">
            <div>
              <strong>Order #${o.id}</strong>
              <p class="text-sm text-muted">${o.date}</p>
            </div>
            <div class="text-right">
              <div class="badge" style="background:${getStatusColor(o.status)}; font-size:0.9rem;">${o.status}</div>
              <p class="mt-2 font-bold">${o.total}</p>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t" style="border-top:1px solid #f0f0f0;">
            ${o.items.map(i => `<p class="text-sm">1x ${i.name}</p>`).join("")}
            <p class="text-xs text-muted mt-2">Paid via: ${o.payment || 'Razorpay'}</p>
          </div>
          <div class="mt-4 flex gap-2">
            ${o.status !== 'Delivered' ? `<a href="track-order.html?id=${o.id}" class="btn outline sm">Track Order</a>` : ''}
            <button class="btn primary sm" onclick="viewInvoice('${o.id}')">View Invoice</button>
          </div>
        </div>
      `).join("");
    }

    function getStatusColor(status) {
      switch(status) {
        case 'Received': return '#f59e0b';
        case 'Baking': return '#e11d48';
        case 'Ready': return '#10b981';
        case 'Out for delivery': return '#3b82f6';
        default: return '#6b7280';
      }
    }

    window.viewInvoice = (id) => {
      const orders = JSON.parse(localStorage.getItem("orders") || "[]");
      const order = orders.find(o => o.id === id);
      if (!order) return;

      const user = JSON.parse(localStorage.getItem("user"));
      const modal = document.getElementById("invoiceModal");
      const content = document.getElementById("invoiceContent");

      const subtotal = order.items.reduce((acc, i) => acc + (i.price * i.qty), 0);
      const delivery = 40;
      const total = subtotal + delivery;

      content.innerHTML = `
        <table cellpadding="0" cellspacing="0">
          <tr class="top">
            <td colspan="2">
              <table>
                <tr>
                  <td class="title">GYAN BAKERY</td>
                  <td>
                    Invoice #: ${order.id}<br>
                    Created: ${order.date}<br>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr class="information">
            <td colspan="2">
              <table>
                <tr>
                  <td>
                    Gyan Bakery, Inc.<br>
                    123 Bakers Street<br>
                    Patna, Bihar 800001
                  </td>
                  <td>
                    ${order.customerName || 'Customer'}<br>
                    ${order.customerEmail || ''}<br>
                    ${order.customerPhone ? 'Phone: ' + order.customerPhone : ''}<br>
                    ${order.customerAddress ? 'Address: ' + order.customerAddress : ''}
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr class="heading">
            <td>Payment Method</td>
            <td>Method #</td>
          </tr>
          <tr class="details">
            <td>${order.payment || 'Razorpay'}</td>
            <td>Confirmed</td>
          </tr>
          <tr class="heading">
            <td>Item</td>
            <td>Price</td>
          </tr>
          ${order.items.map(item => `
            <tr class="item">
              <td>${item.name} (x${item.qty})</td>
              <td>‚Çπ${item.price * item.qty}</td>
            </tr>
          `).join("")}
          <tr class="item">
            <td>Delivery Fee</td>
            <td>‚Çπ${delivery}</td>
          </tr>
          <tr class="total">
            <td></td>
            <td>Total: ‚Çπ${total}</td>
          </tr>
        </table>
      `;

      modal.style.display = "flex";
    };

    window.closeInvoice = () => {
      document.getElementById("invoiceModal").style.display = "none";
    };
  </script>

  <footer>
    <div class="container footer-grid">
      <div>
        <div class="footer-logo">üéÇ Gyan Bakery</div>
        <p>Baking memories since 2010. 100% artisanal, eggless options available.</p>
        <div class="social-links">
          <a href="#" title="Facebook">f</a>
          <a href="#" title="Instagram">ig</a>
          <a href="#" title="Twitter">x</a>
          <a href="#" title="YouTube">yt</a>
        </div>
      </div>
      <div>
        <h3>Quick Links</h3>
        <p><a href="track-order.html">üì¶ Track Order</a></p>
        <p><a href="profile.html">üë§ My Account</a></p>
        <p><a href="products.html">üõçÔ∏è Shop Now</a></p>
      </div>
      <div>
        <h3>Contact & Hours</h3>
        <p>üìç 123 Baker Street, Food City</p>
        <p>üìû +91 98765 43210</p>
        <p>‚úâÔ∏è hello@gyanbakery.com</p>
        <p style="margin-top: 1rem; color: #fff; font-size: 0.9rem; opacity: 0.8;">Mon-Sun: 9AM - 9PM</p>
      </div>
    </div>
    
    <div class="container footer-bottom">
      <p>
        <a href="#">Privacy Policy</a> | 
        <a href="#">Terms of Service</a> | 
        <a href="#">Refund Policy</a>
      </p>
      <p style="margin-top: 1rem; opacity: 0.6;">¬© 2026 Gyan Bakery. All rights reserved. ‚ù§Ô∏è</p>
    </div>
  </footer>
</body>
</html>
